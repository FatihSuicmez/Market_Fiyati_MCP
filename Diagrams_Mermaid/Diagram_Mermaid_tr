%%{ init: { 'theme': 'base', 'themeVariables': { 'primaryColor': '#F9FAFB', 'primaryTextColor': '#111827', 'lineColor': '#4B5563', 'secondaryColor': '#E5E7EB' }}}%%
graph TD
    %% --- NODE TANIMLAMALARI ---
    subgraph "KullanÄ±cÄ± ArayÃ¼zÃ¼"
        User[ğŸ“± KullanÄ±cÄ±]
    end

    subgraph "n8n Ä°ÅŸ AkÄ±ÅŸÄ± Motoru"
        Trigger["Listen for incoming events (Telegram Trigger)"]
        Router{"If (Gelen Mesaj TÃ¼rÃ¼?)"}
        
        subgraph "Girdi Ä°ÅŸleme KollarÄ±"
            KonumYonetimi["ğŸ“ Konum YÃ¶netimi<br/>(If1, Code1, staticData)"]
            SesIsleme["ğŸ”Š Ses Ä°ÅŸleme<br/>(Get Voice File -> 3x HTTP Request)"]
            ResimIsleme["ğŸ–¼ï¸ Resim Ä°ÅŸleme<br/>(Get a file -> 3x HTTP Request)"]
        end

        SorguHazirlama["âš™ï¸ Sorgu HazÄ±rlama (Code4)<br/>Metin ve Konumu BirleÅŸtirir"]
        Agent["ğŸ¤– CepAssist Agent"]
        
        subgraph "SonuÃ§ Sunum MantÄ±ÄŸÄ±"
            SonucKontrol{"If (SonuÃ§ Var mÄ±?)"}
            GirisMesaji["âœ‰ï¸ Telegram (GiriÅŸ CÃ¼mlesi)"]
            HataMesaji["ğŸš« Telegram (ÃœrÃ¼n BulunamadÄ±)"]
            SplitOut["Split Out (ÃœrÃ¼nleri AyÄ±rÄ±r)"]
            ResimFiltre{"If (Resim GeÃ§erli mi?)"}
            LogoEkle["Set (Logo Ekler)"]
            SonucGonder["ğŸ–¼ï¸ Telegram (sendPhoto)"]
        end
    end

    subgraph "Python MCP Sunucusu (Yerel Makine)"
        Ngrok[ğŸŒ Ngrok TÃ¼neli]
        MCPServer["market_fiyati_mcp_server.py"]
        Client["client.py"]
        Dashboard["dashboard.py (Token iÃ§in)"]
    end

    subgraph "Harici Servisler"
        TelegramAPI[âœˆï¸ Telegram API]
        MarketAPI["marketfiyati.org.tr API<br/>(/nearest, /search)"]
        GeminiFileAPI["Google Gemini File API<br/>(Ses/Resim YÃ¼kleme)"]
    end

    %% --- BAÄLANTILAR ---
    User -- "Metin, Ses, Resim, Konum" --> TelegramAPI
    TelegramAPI --> Trigger
    Trigger --> Router
    Router -- "Konum ise" --> KonumYonetimi
    Router -- "Resim ise" --> ResimIsleme
    Router -- "Ses ise" --> SesIsleme
    Router -- "Metin ise (default)" --> SorguHazirlama
    ResimIsleme -- "TanÄ±nan ÃœrÃ¼n AdÄ±" --> SorguHazirlama
    SesIsleme -- "DeÅŸifre EdilmiÅŸ Metin" --> SorguHazirlama
    SorguHazirlama -- "agent_input" --> Agent
    Agent -- "MCP Ã‡aÄŸrÄ±sÄ± (tool call)" --> Ngrok
    Ngrok --> MCPServer
    MCPServer --> Client
    Client -- "Fiyat Sorgusu" --> MarketAPI
    ResimIsleme --> GeminiFileAPI
    SesIsleme --> GeminiFileAPI
    Dashboard -- "Bearer Token saÄŸlar (gÃ¼venlik)" --> Agent
    MarketAPI -- "ÃœrÃ¼n Listesi + Mesafe" --> Client
    Client -- "Ä°ÅŸlenmiÅŸ ÃœrÃ¼n Listesi" --> MCPServer
    MCPServer -- "ShoppingListResult" --> Ngrok
    Ngrok --> Agent
    Agent -- "JSON Ã‡Ä±ktÄ±sÄ±" --> SonucKontrol
    SonucKontrol -- "ÃœrÃ¼n Yoksa (FALSE)" --> HataMesaji
    SonucKontrol -- "ÃœrÃ¼n Varsa (TRUE)" --> GirisMesaji
    HataMesaji --> TelegramAPI
    GirisMesaji --> SplitOut
    SplitOut -- "Her ÃœrÃ¼n Ä°Ã§in" --> ResimFiltre
    ResimFiltre -- "GeÃ§ersizse (FALSE)" --> LogoEkle
    ResimFiltre -- "GeÃ§erliyse (TRUE)" --> SonucGonder
    LogoEkle --> SonucGonder
    SonucGonder --> TelegramAPI

    %% --- STYLING (Yeni YÃ¶ntem) ---
    %% KullanÄ±cÄ± ArayÃ¼zÃ¼ (AÃ§Ä±k Mavi)
    style User fill:#E0F7FA,stroke:#00796B,stroke-width:2px,color:#004D40
    style TelegramAPI fill:#E0F7FA,stroke:#00796B,stroke-width:2px,color:#004D40

    %% n8n Ä°ÅŸ AkÄ±ÅŸÄ± (AÃ§Ä±k Mor)
    style Trigger fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style Router fill:#EDE7F6,stroke:#D81B60,stroke-width:3px,color:#311B92
    style KonumYonetimi fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style SesIsleme fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style ResimIsleme fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style SorguHazirlama fill:#D1C4E9,stroke:#5E35B1,stroke-width:3px,color:#311B92
    style Agent fill:#D1C4E9,stroke:#5E35B1,stroke-width:3px,color:#311B92
    style SonucKontrol fill:#EDE7F6,stroke:#D81B60,stroke-width:3px,color:#311B92
    style ResimFiltre fill:#EDE7F6,stroke:#D81B60,stroke-width:3px,color:#311B92
    style GirisMesaji fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style HataMesaji fill:#FFCDD2,stroke:#C62828,stroke-width:2px,color:#B71C1C
    style SplitOut fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style LogoEkle fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92
    style SonucGonder fill:#EDE7F6,stroke:#5E35B1,stroke-width:2px,color:#311B92

    %% Python Sunucusu (AÃ§Ä±k YeÅŸil)
    style Ngrok fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20
    style MCPServer fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20
    style Client fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20
    style Dashboard fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20

    %% Harici Servisler (AÃ§Ä±k Turuncu)
    style MarketAPI fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100
    style GeminiFileAPI fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100